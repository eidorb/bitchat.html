# Build separately to avoid bloated image
FROM --platform=i386 i386/debian:trixie AS builder
RUN apt-get update && apt-get install -y git curl rustc cargo libdbus-1-dev
COPY ./bitchat-terminal /bitchat-terminal
WORKDIR /bitchat-terminal
RUN cargo build --release
# Install uv
ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh && rm /uv-installer.sh

FROM --platform=i386 i386/debian:trixie
ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get -y upgrade && \
	apt-get install -y apt-utils bsdmainutils ca-certificates \
	cpio curl dmidecode dmsetup git \
	hexedit ifupdown init logrotate lsb-base lshw \
	netbase openssl procps python3 python3-cryptography \
	readline-common rsyslog sensible-utils \
	ssh systemd systemd-sysv udev vim wget whiptail \
	xxd iptables isc-dhcp-client isc-dhcp-common kmod less netcat-openbsd \
	# for bitchat-python, no python3-aioconsole for bookworm
	python3-bleak python3-lz4 \
	# for bitchat-cli
	python3-prompt-toolkit \
	# for silly ideas
	usbip tmux

# Make a user
RUN useradd -m user && echo "user:password" | chpasswd

# Copy projects and scripts
COPY --chown=user:user ./bitchat /home/user/bitchat
RUN chmod +x /home/user/bitchat/start_tmux.sh

# Install Python packages 
COPY --from=builder /root/.local/bin/uv /bin/uv
RUN uv pip install --system --break-system-packages aioconsole pybloom-live # for bitchat-python

# Copy bitchat-terminal binary from builder
COPY --from=builder /bitchat-terminal/target/release/bitchat /bin/bitchat

WORKDIR /home/user/bitchat
RUN echo 'root:password' | chpasswd
CMD [ "/bin/bash" ]
