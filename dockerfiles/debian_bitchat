# bitchat-terminal requires rustc 1.85+, available in trixie
FROM --platform=i386 i386/debian:trixie AS builder
RUN apt-get update && apt-get install -y git curl rustc cargo libdbus-1-dev
COPY ./bitchat-terminal /bitchat-terminal
WORKDIR /bitchat-terminal
RUN cargo build --release
# Install uv
ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh

# webvm.io uses buster, try bullseye
FROM --platform=i386 i386/debian:bullseye
ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get -y upgrade && \
	apt-get install -y apt-utils bsdmainutils ca-certificates \
	cpio curl dmidecode dmsetup git \
	hexedit ifupdown init logrotate lsb-base lshw \
	netbase openssl procps python3 python3-cryptography \
	readline-common rsyslog sensible-utils \
	ssh systemd systemd-sysv udev vim wget whiptail \
	xxd iptables isc-dhcp-client isc-dhcp-common kmod less netcat-openbsd \
	# required for packaging on old python (bullseye)
	python3-distutils \
	# for bitchat-python (bookworm has python3-bleak,trixie has python3-aioconsole)
	python3-lz4 \
	# for bitchat-cli
	python3-prompt-toolkit \
	# for silly ideas
	usbip tmux

# Make a user
RUN useradd -m user && echo "user:password" | chpasswd

# Copy projects and scripts
COPY --chown=user:user ./bitchat /home/user/bitchat
RUN chmod +x /home/user/bitchat/start_tmux.sh

# Install Python packages 
COPY --from=builder /root/.local/bin/uv /bin/uv
RUN uv pip install --system --break-system-packages aioconsole bleak pybloom-live # for bitchat-python

# Copy bitchat-terminal binary from builder
COPY --from=builder /bitchat-terminal/target/release/bitchat /bin/bitchat

# We set WORKDIR, as this gets extracted by Webvm to be used as the cwd. This is optional.
WORKDIR /home/user/bitchat
# We set env, as this gets extracted by Webvm. This is optional.
ENV HOME="/home/user" TERM="xterm" USER="user" SHELL="/bin/bash" EDITOR="vim" LANG="en_US.UTF-8" LC_ALL="C"
RUN echo 'root:password' | chpasswd
CMD [ "/bin/bash" ]
