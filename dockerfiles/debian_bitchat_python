# Build separately to avoid bloated image
FROM --platform=i386 i386/debian:trixie AS builder
RUN apt-get update && apt-get install -y git rustc cargo libdbus-1-dev
RUN cargo install --git https://github.com/ShilohEye/bitchat-terminal --root /usr/local

FROM --platform=i386 i386/debian:trixie
ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get -y upgrade && \
	apt-get install -y apt-utils bsdmainutils ca-certificates \
	cpio curl dmidecode dmsetup git \
	hexedit ifupdown init logrotate lsb-base lshw \
	netbase openssl procps python3 python3-cryptography \
	readline-common rsyslog sensible-utils \
	ssh systemd systemd-sysv udev vim wget whiptail \
	xxd iptables isc-dhcp-client isc-dhcp-common kmod less netcat-openbsd \
	# for bitchat-python, no python3-aioconsole for bookworm
	python3-bleak python3-lz4 \
	# for bitchat-cli
	python3-prompt-toolkit \
	# for silly ideas
	usbip tmux

# Make a user, then copy over the /example directory
RUN useradd -m user && echo "user:password" | chpasswd

# Install uv to user's dir
ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh && rm /uv-installer.sh
RUN mv /root/.local /home/user/
ENV PATH="/home/user/.local/bin/:$PATH"

# Clone repos
WORKDIR /home/user
RUN git clone https://github.com/kaganisildak/bitchat-python.git
RUN git clone https://github.com/dearabhin/bitchat-cli.git

# Install additional packages
RUN uv pip install --system --break-system-packages aioconsole pybloom-live # for bitchat-python

# Copy bitchat-terminal binary from builder
COPY --from=builder /usr/local/bin/bitchat /usr/local/bin/bitchat

RUN echo 'root:password' | chpasswd
CMD [ "/bin/bash" ]
